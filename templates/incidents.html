{% extends 'base.html' %}

{% block title %}Incident Management{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <div class="row mb-4">
        <div class="col-md-8">
            <h2>Incident Management</h2>
            <p class="text-muted">Track, manage, and resolve incidents from shipments and tours</p>
        </div>
        <div class="col-md-4 text-end">
            <button class="btn btn-danger" onclick="openIncidentModal()">
                <i class="bi bi-exclamation-triangle"></i> Report Incident
            </button>
        </div>
    </div>

    {% if messages %}
        {% for message in messages %}
            <div class="alert alert-success alert-dismissible fade show" role="alert">
                {{ message }}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
        {% endfor %}
    {% endif %}

    <!-- Incident Statistics -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card bg-danger text-white">
                <div class="card-body">
                    <h5>Total Incidents</h5>
                    <h3 id="totalIncidents">0</h3>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-warning text-dark">
                <div class="card-body">
                    <h5>Pending</h5>
                    <h3 id="pendingIncidents">0</h3>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-success text-white">
                <div class="card-body">
                    <h5>Resolved</h5>
                    <h3 id="resolvedIncidents">0</h3>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-info text-white">
                <div class="card-body">
                    <h5>This Month</h5>
                    <h3 id="monthlyIncidents">0</h3>
                </div>
            </div>
        </div>
    </div>

    <!-- Incident Filters -->
    <div class="card mb-4">
        <div class="card-header">
            <h5 class="mb-0">Incident Filters</h5>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-3">
                    <label class="form-label">Incident Type</label>
                    <select class="form-select" id="incidentTypeFilter">
                        <option value="">All Types</option>
                        <option value="Retard">Delay</option>
                        <option value="Perte">Loss</option>
                        <option value="Endommagement">Damage</option>
                        <option value="Problème technique">Technical Issue</option>
                        <option value="Accident">Accident</option>
                        <option value="Autre">Other</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label class="form-label">Severity</label>
                    <select class="form-select" id="severityFilter">
                        <option value="">All Severities</option>
                        <option value="Mineure">Minor</option>
                        <option value="Moyenne">Medium</option>
                        <option value="Majeure">Major</option>
                        <option value="Critique">Critical</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label class="form-label">Status</label>
                    <select class="form-select" id="statusFilter">
                        <option value="">All Status</option>
                        <option value="false">Pending</option>
                        <option value="true">Resolved</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label class="form-label">Date Range</label>
                    <input type="date" class="form-control" id="dateFilter">
                </div>
            </div>
            <div class="row mt-3">
                <div class="col-12">
                    <button class="btn btn-primary" onclick="applyFilters()">Apply Filters</button>
                    <button class="btn btn-secondary" onclick="resetFilters()">Reset</button>
                    <button class="btn btn-success" onclick="exportIncidents()">Export Report</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Incidents Table -->
    <div class="card">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h5 class="mb-0">Incident Log</h5>
            <div>
                <button class="btn btn-sm btn-outline-info" onclick="refreshIncidents()">
                    <i class="bi bi-arrow-clockwise"></i> Refresh
                </button>
                <button class="btn btn-sm btn-outline-warning" onclick="generateIncidentReport()">
                    <i class="bi bi-file-text"></i> Generate Report
                </button>
            </div>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-striped">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Type</th>
                            <th>Severity</th>
                            <th>Related To</th>
                            <th>Description</th>
                            <th>Date</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="incidentsTableBody">
                        <!-- Incidents will be loaded here -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Incident Analytics -->
    <div class="row mt-4">
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">Incident Types Distribution</h5>
                </div>
                <div class="card-body">
                    <canvas id="incidentTypesChart"></canvas>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">Incident Trends</h5>
                </div>
                <div class="card-body">
                    <canvas id="incidentTrendsChart"></canvas>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Incident Modal -->
<div class="modal fade" id="incidentModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Report New Incident</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="incidentForm">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Incident Type</label>
                            <select class="form-select" id="incidentType" required>
                                <option value="">Select type</option>
                                <option value="Retard">Delay</option>
                                <option value="Perte">Loss</option>
                                <option value="Endommagement">Damage</option>
                                <option value="Problème technique">Technical Issue</option>
                                <option value="Accident">Accident</option>
                                <option value="Autre">Other</option>
                            </select>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Severity</label>
                            <select class="form-select" id="incidentSeverity" required>
                                <option value="">Select severity</option>
                                <option value="Mineure">Minor</option>
                                <option value="Moyenne">Medium</option>
                                <option value="Majeure">Major</option>
                                <option value="Critique">Critical</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Related To</label>
                            <select class="form-select" id="relatedTo" onchange="updateRelatedOptions()">
                                <option value="">Select type</option>
                                <option value="shipment">Shipment</option>
                                <option value="tour">Tour</option>
                            </select>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Select Item</label>
                            <select class="form-select" id="relatedItem">
                                <option value="">First select type above</option>
                            </select>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Description</label>
                        <textarea class="form-control" id="incidentDescription" rows="4" required placeholder="Describe the incident in detail..."></textarea>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Attach Documents (Optional)</label>
                        <input type="file" class="form-control" id="incidentDocuments" multiple accept="image/*,.pdf,.doc,.docx">
                        <small class="text-muted">Upload photos, PDFs, or documents related to the incident</small>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="sendAlert">
                                <label class="form-check-label" for="sendAlert">
                                    Send alert to management
                                </label>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="notifyClient">
                                <label class="form-check-label" for="notifyClient">
                                    Notify affected client
                                </label>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" onclick="submitIncident()">Report Incident</button>
            </div>
        </div>
    </div>
</div>

<!-- Incident Details Modal -->
<div class="modal fade" id="incidentDetailsModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Incident Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="incidentDetailsContent">
                <!-- Details will be loaded here -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-success" id="resolveIncidentBtn" onclick="resolveIncident()">Mark as Resolved</button>
            </div>
        </div>
    </div>
</div>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
// Initialize incident management
document.addEventListener('DOMContentLoaded', function() {
    loadIncidents();
    initializeCharts();
    updateStatistics();
});

function loadIncidents() {
    // Sample data - replace with API call
    const incidents = [
        {
            id: 1,
            type: 'Retard',
            severity: 'Moyenne',
            relatedTo: 'shipment',
            relatedId: 'TRK123456',
            description: 'Delivery delayed due to traffic congestion',
            date: '2025-01-20',
            resolved: false
        },
        {
            id: 2,
            type: 'Endommagement',
            severity: 'Majeure',
            relatedTo: 'shipment',
            relatedId: 'TRK789012',
            description: 'Package damaged during handling',
            date: '2025-01-19',
            resolved: true
        },
        {
            id: 3,
            type: 'Problème technique',
            severity: 'Mineure',
            relatedTo: 'tour',
            relatedId: 'TOUR-001',
            description: 'Vehicle breakdown - minor engine issue',
            date: '2025-01-18',
            resolved: true
        }
    ];
    
    const tbody = document.getElementById('incidentsTableBody');
    tbody.innerHTML = '';
    
    incidents.forEach(incident => {
        const severityClass = incident.severity === 'Critique' ? 'danger' : 
                            incident.severity === 'Majeure' ? 'warning' : 
                            incident.severity === 'Moyenne' ? 'info' : 'secondary';
        
        const statusBadge = incident.resolved ? 
            '<span class="badge bg-success">Resolved</span>' : 
            '<span class="badge bg-warning">Pending</span>';
        
        const row = `
            <tr>
                <td>INC-${incident.id.toString().padStart(4, '0')}</td>
                <td>${incident.type}</td>
                <td><span class="badge bg-${severityClass}">${incident.severity}</span></td>
                <td>${incident.relatedTo.toUpperCase()} - ${incident.relatedId}</td>
                <td>${incident.description.substring(0, 50)}...</td>
                <td>${incident.date}</td>
                <td>${statusBadge}</td>
                <td>
                    <div class="btn-group btn-group-sm">
                        <button class="btn btn-outline-info" onclick="viewIncidentDetails(${incident.id})">
                            <i class="bi bi-eye"></i>
                        </button>
                        ${!incident.resolved ? `<button class="btn btn-outline-success" onclick="quickResolve(${incident.id})">
                            <i class="bi bi-check"></i>
                        </button>` : ''}
                        <button class="btn btn-outline-primary" onclick="printIncident(${incident.id})">
                            <i class="bi bi-printer"></i>
                        </button>
                    </div>
                </td>
            </tr>
        `;
        tbody.innerHTML += row;
    });
}

function updateStatistics() {
    // Update statistics with sample data
    document.getElementById('totalIncidents').textContent = '3';
    document.getElementById('pendingIncidents').textContent = '1';
    document.getElementById('resolvedIncidents').textContent = '2';
    document.getElementById('monthlyIncidents').textContent = '3';
}

function initializeCharts() {
    // Incident Types Chart
    const typesCtx = document.getElementById('incidentTypesChart').getContext('2d');
    new Chart(typesCtx, {
        type: 'doughnut',
        data: {
            labels: ['Delay', 'Damage', 'Technical', 'Loss', 'Other'],
            datasets: [{
                data: [1, 1, 1, 0, 0],
                backgroundColor: [
                    '#ffc107',
                    '#dc3545',
                    '#0dcaf0',
                    '#6c757d',
                    '#198754'
                ]
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: { position: 'bottom' }
            }
        }
    });

    // Incident Trends Chart
    const trendsCtx = document.getElementById('incidentTrendsChart').getContext('2d');
    new Chart(trendsCtx, {
        type: 'line',
        data: {
            labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun'],
            datasets: [{
                label: 'Incidents',
                data: [2, 3, 1, 4, 2, 3],
                borderColor: '#dc3545',
                backgroundColor: 'rgba(220, 53, 69, 0.1)',
                tension: 0.4
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: { display: false }
            },
            scales: {
                y: { beginAtZero: true }
            }
        }
    });
}

function openIncidentModal() {
    document.getElementById('incidentForm').reset();
    new bootstrap.Modal(document.getElementById('incidentModal')).show();
}

function updateRelatedOptions() {
    const relatedTo = document.getElementById('relatedTo').value;
    const itemSelect = document.getElementById('relatedItem');
    
    itemSelect.innerHTML = '<option value="">Select item</option>';
    
    if (relatedTo === 'shipment') {
        // Load shipments
        const shipments = ['TRK123456', 'TRK789012', 'TRK345678'];
        shipments.forEach(shipment => {
            const option = document.createElement('option');
            option.value = shipment;
            option.textContent = shipment;
            itemSelect.appendChild(option);
        });
    } else if (relatedTo === 'tour') {
        // Load tours
        const tours = ['TOUR-001', 'TOUR-002', 'TOUR-003'];
        tours.forEach(tour => {
            const option = document.createElement('option');
            option.value = tour;
            option.textContent = tour;
            itemSelect.appendChild(option);
        });
    }
}

function submitIncident() {
    const form = document.getElementById('incidentForm');
    if (!form.checkValidity()) {
        form.reportValidity();
        return;
    }
    
    // In real implementation, this would send data to Django backend
    const incidentData = {
        type: document.getElementById('incidentType').value,
        severity: document.getElementById('incidentSeverity').value,
        relatedTo: document.getElementById('relatedTo').value,
        relatedItem: document.getElementById('relatedItem').value,
        description: document.getElementById('incidentDescription').value,
        sendAlert: document.getElementById('sendAlert').checked,
        notifyClient: document.getElementById('notifyClient').checked
    };
    
    console.log('Incident reported:', incidentData);
    alert('Incident reported successfully!');
    
    // Close modal and refresh
    bootstrap.Modal.getInstance(document.getElementById('incidentModal')).hide();
    loadIncidents();
    updateStatistics();
}

function viewIncidentDetails(incidentId) {
    // Load incident details
    const details = {
        id: incidentId,
        type: 'Retard',
        severity: 'Moyenne',
        description: 'Delivery delayed due to traffic congestion on the A1 highway. Estimated delay of 2 hours.',
        date: '2025-01-20',
        relatedTo: 'shipment',
        relatedId: 'TRK123456',
        resolved: false,
        actions: ['Contacted driver', 'Updated customer', 'Rerouted delivery']
    };
    
    const content = `
        <div class="row">
            <div class="col-md-6">
                <strong>Incident ID:</strong> INC-${details.id.toString().padStart(4, '0')}<br>
                <strong>Type:</strong> ${details.type}<br>
                <strong>Severity:</strong> ${details.severity}<br>
                <strong>Date:</strong> ${details.date}<br>
                <strong>Status:</strong> ${details.resolved ? 'Resolved' : 'Pending'}
            </div>
            <div class="col-md-6">
                <strong>Related To:</strong> ${details.relatedTo.toUpperCase()} - ${details.relatedId}<br>
                <strong>Description:</strong> ${details.description}<br>
                <strong>Actions Taken:</strong><br>
                <ul>
                    ${details.actions.map(action => `<li>${action}</li>`).join('')}
                </ul>
            </div>
        </div>
    `;
    
    document.getElementById('incidentDetailsContent').innerHTML = content;
    
    // Show/hide resolve button
    const resolveBtn = document.getElementById('resolveIncidentBtn');
    resolveBtn.style.display = details.resolved ? 'none' : 'block';
    resolveBtn.onclick = () => resolveIncident();
    
    new bootstrap.Modal(document.getElementById('incidentDetailsModal')).show();
}

function resolveIncident() {
    // Mark incident as resolved
    alert('Incident marked as resolved!');
    bootstrap.Modal.getInstance(document.getElementById('incidentDetailsModal')).hide();
    loadIncidents();
    updateStatistics();
}

function quickResolve(incidentId) {
    if (confirm('Mark this incident as resolved?')) {
        resolveIncident();
    }
}

function printIncident(incidentId) {
    alert(`Printing incident report for ID: ${incidentId}`);
}

function applyFilters() {
    // Apply filters to incidents table
    const type = document.getElementById('incidentTypeFilter').value;
    const severity = document.getElementById('severityFilter').value;
    const status = document.getElementById('statusFilter').value;
    const date = document.getElementById('dateFilter').value;
    
    console.log('Applying filters:', { type, severity, status, date });
    // In real implementation, this would filter the displayed incidents
    loadIncidents(); // Reload with filters
}

function resetFilters() {
    document.getElementById('incidentTypeFilter').value = '';
    document.getElementById('severityFilter').value = '';
    document.getElementById('statusFilter').value = '';
    document.getElementById('dateFilter').value = '';
    loadIncidents();
}

function refreshIncidents() {
    loadIncidents();
    updateStatistics();
}

function generateIncidentReport() {
    alert('Generating comprehensive incident report...');
}

function exportIncidents() {
    alert('Exporting incidents to Excel/CSV...');
}
</script>
{% endblock %}
